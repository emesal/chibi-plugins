#!/bin/bash
# Spawn a sub-agent in another context
#
# This tool creates/uses a sub-agent in a different context and sends a task.
# The sub-agent runs in isolation without changing global state.
#
# Security note: This tool can execute arbitrary prompts via chibi.
# The prompts are visible in conversation history and transcripts.

if [[ "$1" == "--schema" ]]; then
  cat <<'EOF'
{
  "name": "sub-agent",
  "description": "Spawn a sub-agent in another context. Creates a new context (or uses existing) and sends a task. Returns the agent's response.",
  "parameters": {
    "type": "object",
    "properties": {
      "context": {
        "type": "string",
        "description": "Target context name, or 'new' for auto-generated name"
      },
      "task": {
        "type": "string",
        "description": "The task for the sub-agent"
      },
      "system_prompt": {
        "type": "string",
        "description": "Optional system prompt for the context"
      }
    },
    "required": ["context", "task"]
  }
}
EOF
  exit 0
fi

# Read args from env var
context=$(echo "$CHIBI_TOOL_ARGS" | jq -r '.context // empty')
task=$(echo "$CHIBI_TOOL_ARGS" | jq -r '.task // empty')
system_prompt=$(echo "$CHIBI_TOOL_ARGS" | jq -r '.system_prompt // empty')

if [[ -z "$task" ]]; then
  echo '{"error": "task is required"}'
  exit 0
fi

if [[ -z "$context" ]]; then
  echo '{"error": "context is required"}'
  exit 0
fi

# Validate context name (unless it's "new" or "new:prefix")
if [[ "$context" != "new" && ! "$context" =~ ^new: && ! "$context" =~ ^[a-zA-Z0-9_-]+$ ]]; then
  echo '{"error": "Invalid context name. Must be alphanumeric with dashes and underscores only, or use '\''new'\'' for auto-generated name."}'
  exit 0
fi

if [[ -n "$CHIBI_VERBOSE" ]]; then
  echo "[sub-agent: spawning in context '$context']" >&2
fi

# Build the chibi command
# -S runs in sub-context (doesn't change global state)
# -e sets system prompt (optional, can be combined with task)
if [[ -n "$system_prompt" ]]; then
  response=$(chibi -S "$context" -e "$system_prompt" "$task" 2>/dev/null)
else
  response=$(chibi -S "$context" "$task" 2>/dev/null)
fi

# Return as JSON
echo "{\"context\": \"$context\", \"response\": $(echo "$response" | jq -Rs .)}"
