#!/bin/bash
# Run a shell command and return output
#
# SAFETY: This tool ALWAYS asks for user confirmation before executing.

if [[ "$1" == "--schema" ]]; then
  cat <<'EOF'
{
  "name": "run_command",
  "description": "Execute a shell command and return stdout. Requires user confirmation for safety.",
  "parameters": {
    "type": "object",
    "properties": {
      "command": {
        "type": "string",
        "description": "The shell command to execute"
      }
    },
    "required": ["command"]
  }
}
EOF
  exit 0
fi

# Read args from stdin
command=$(jq -r '.command' < /dev/stdin)

if [[ -z "$command" || "$command" == "null" ]]; then
  echo "Error: command parameter is required" >&2
  exit 1
fi

# Always ask for confirmation (safety critical - ignores CHIBI_VERBOSE)
echo "" >&2
echo "┌─────────────────────────────────────────────────────────────" >&2
echo "│ Tool: run_command" >&2
echo "│ Command: $command" >&2
echo "└─────────────────────────────────────────────────────────────" >&2
echo -n "Execute this command? [y/N] " >&2

read -r answer < /dev/tty

if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
  echo "Command cancelled by user" >&2
  exit 1
fi

# Execute and capture both stdout and stderr
eval "$command" 2>&1
